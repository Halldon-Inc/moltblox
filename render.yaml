# Render Blueprint for Moltblox
# Docs: https://docs.render.com/blueprint-spec

services:
  # ─── API Server (Express + Prisma + WebSocket) ─────────────
  - type: web
    name: moltblox-server
    runtime: docker
    region: oregon
    plan: starter
    dockerfilePath: apps/server/Dockerfile
    dockerContext: .
    healthCheckPath: /health
    buildFilter:
      paths:
        - apps/server/**
        - packages/protocol/**
        - pnpm-lock.yaml
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3001"
      - key: HOST
        value: 0.0.0.0
      - key: DATABASE_URL
        fromDatabase:
          name: moltblox-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: moltblox-redis
          type: keyvalue
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRY
        value: 7d
      - key: CORS_ORIGIN
        sync: false
      - key: MOLTBOOK_API_URL
        sync: false
      - key: MOLTBOOK_APP_KEY
        sync: false
      - key: SENTRY_DSN
        sync: false
      - key: BASE_RPC_URL
        sync: false
      - key: MOLTBUCKS_ADDRESS
        sync: false
      - key: GAME_MARKETPLACE_ADDRESS
        sync: false
      - key: TOURNAMENT_MANAGER_ADDRESS
        sync: false

  # ─── Web Frontend (Next.js Standalone) ─────────────────────
  - type: web
    name: moltblox-web
    runtime: node
    region: oregon
    plan: starter
    rootDir: .
    buildCommand: "export NODE_ENV=development HUSKY=0 STANDALONE=true && pnpm install --frozen-lockfile && pnpm build --filter=@moltblox/web... && ls apps/web/.next/standalone/apps/web/server.js"
    startCommand: "node apps/web/.next/standalone/apps/web/server.js"
    buildFilter:
      paths:
        - apps/web/**
        - packages/protocol/**
        - packages/game-builder/**
        - pnpm-lock.yaml
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3000"
      - key: STANDALONE
        value: "true"
      - key: NEXT_PUBLIC_API_URL
        sync: false
      - key: NEXT_PUBLIC_WS_URL
        sync: false
      - key: NEXT_PUBLIC_MOLTBUCKS_ADDRESS
        sync: false
      - key: NEXT_PUBLIC_GAME_MARKETPLACE_ADDRESS
        sync: false
      - key: NEXT_PUBLIC_TOURNAMENT_MANAGER_ADDRESS
        sync: false
      - key: NEXT_PUBLIC_WC_PROJECT_ID
        sync: false
      - key: NEXT_PUBLIC_SENTRY_DSN
        sync: false
      - key: NEXT_PUBLIC_CHAIN_ID
        sync: false
      - key: SENTRY_ORG
        sync: false
      - key: SENTRY_PROJECT
        sync: false

  # ─── Redis (Key Value Store) ───────────────────────────────
  - type: keyvalue
    name: moltblox-redis
    plan: starter
    region: oregon
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []  # internal access only (from Render services)

databases:
  # ─── PostgreSQL ─────────────────────────────────────────────
  - name: moltblox-db
    plan: basic-256mb
    region: oregon
    databaseName: moltblox
    user: moltblox
