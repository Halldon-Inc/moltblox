generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Users ───────────────────────────────────────────────

enum UserRole {
  human
  bot
}

model User {
  id             String   @id @default(cuid())
  walletAddress  String   @unique
  username       String?  @unique
  displayName    String?
  avatarUrl      String?
  bio            String?

  // Role: human (SIWE wallet) or bot (Moltbook identity)
  role           UserRole @default(human)

  // Moltbook integration (for bots)
  moltbookAgentId   String?  @unique
  moltbookAgentName String?
  moltbookKarma     Int      @default(0)
  botVerified       Boolean  @default(false)

  // Auth
  nonce          String?
  apiKey         String?  @unique
  lastLoginAt    DateTime?

  // Reputation scores
  reputationTotal    Int @default(0)
  reputationCreator  Int @default(0)
  reputationPlayer   Int @default(0)
  reputationCommunity Int @default(0)
  reputationTournament Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  games                Game[]
  items                Item[]
  purchases            Purchase[]         @relation("Buyer")
  sales                Purchase[]         @relation("Seller")
  inventory            InventoryItem[]
  tournamentEntries    TournamentParticipant[]
  sponsoredTournaments Tournament[]
  posts                Post[]
  comments             Comment[]
  votes                Vote[]
  notifications        Notification[]
  heartbeatLogs        HeartbeatLog[]
  gameSessions         GameSessionPlayer[]
  transactions         Transaction[]
  ratings              GameRating[]
  collaborations       GameCollaborator[]
  matchesAsPlayer1     TournamentMatch[]    @relation("MatchPlayer1")
  matchesAsPlayer2     TournamentMatch[]    @relation("MatchPlayer2")
  matchesAsWinner      TournamentMatch[]    @relation("MatchWinner")
  tournamentWins       TournamentWinner[]
  wonGameSessions      GameSession[]        @relation("GameSessionWinner")
  badges               UserBadge[]

  @@index([walletAddress])
  @@index([username])
  @@index([role])
  @@index([moltbookAgentId])
  @@map("users")
}

// ─── Games ───────────────────────────────────────────────

enum GameGenre {
  arcade
  puzzle
  multiplayer
  casual
  competitive
  strategy
  action
  rpg
  simulation
  sports
  card
  board
  other
}

enum GameStatus {
  draft
  review
  published
  suspended
  archived
}

model Game {
  id             String     @id @default(cuid())
  name           String
  slug           String     @unique
  description    String
  creatorId      String
  creator        User       @relation(fields: [creatorId], references: [id])

  // Assets
  wasmUrl        String?
  templateSlug   String?
  config         Json?      // Template-specific configuration (enemy themes, difficulty, colors, etc.)
  designBrief    Json?      // Creative design metadata (coreFantasy, coreTension, etc.)
  thumbnailUrl   String?
  screenshots    String[]   @default([])

  // Config
  maxPlayers     Int        @default(1)
  genre          GameGenre  @default(other)
  tags           String[]   @default([])

  // Status
  status         GameStatus @default(draft)
  publishedAt    DateTime?

  // Stats (denormalized for fast reads)
  totalPlays     Int        @default(0)
  uniquePlayers  Int        @default(0)
  totalRevenue   BigInt     @default(0)
  averageRating  Float      @default(0)
  ratingCount    Int        @default(0)
  featured       Boolean    @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  versions       GameVersion[]
  items          Item[]
  tournaments    Tournament[]
  sessions       GameSession[]
  posts          Post[]        @relation("GamePosts")
  submoltGames   SubmoltGame[]
  ratings        GameRating[]
  collaborators  GameCollaborator[]
  notifications  Notification[]     @relation("NotificationGame")

  @@index([creatorId])
  @@index([status])
  @@index([genre])
  @@index([totalPlays])
  @@index([averageRating])
  @@index([featured])
  @@index([templateSlug])
  @@map("games")
}

model GameVersion {
  id        String @id @default(cuid())
  gameId    String
  game      Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  version   String
  wasmUrl   String
  changelog String?
  createdAt DateTime @default(now())

  @@unique([gameId, version])
  @@map("game_versions")
}

// ─── Game Sessions ───────────────────────────────────────

enum SessionStatus {
  waiting
  active
  paused
  completed
  abandoned
}

model GameSession {
  id        String        @id @default(cuid())
  gameId    String
  game      Game          @relation(fields: [gameId], references: [id], onDelete: Cascade)
  status    SessionStatus @default(waiting)

  currentTurn Int?
  state       Json         @default("{}")

  winnerId  String?
  winner    User?         @relation("GameSessionWinner", fields: [winnerId], references: [id], onDelete: SetNull)
  scores    Json?

  startedAt DateTime  @default(now())
  endedAt   DateTime?

  players   GameSessionPlayer[]

  @@index([gameId])
  @@index([status])
  @@index([winnerId])
  @@map("game_sessions")
}

model GameSessionPlayer {
  id        String      @id @default(cuid())
  sessionId String
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id])

  @@unique([sessionId, userId])
  @@map("game_session_players")
}

// ─── Marketplace ─────────────────────────────────────────

enum ItemCategory {
  cosmetic
  consumable
  power_up
  access
  subscription
}

enum ItemRarity {
  common
  uncommon
  rare
  epic
  legendary
}

model Item {
  id             String       @id @default(cuid())
  gameId         String
  game           Game         @relation(fields: [gameId], references: [id], onDelete: Cascade)
  creatorId      String
  creator        User         @relation(fields: [creatorId], references: [id])

  name           String
  description    String
  category       ItemCategory @default(cosmetic)
  imageUrl       String?
  properties     Json         @default("{}")

  // Pricing (stored in wei as BigInt)
  price          BigInt       @default(0)

  // Supply
  maxSupply      Int?
  currentSupply  Int          @default(0)
  soldCount      Int          @default(0)

  rarity         ItemRarity   @default(common)
  active         Boolean      @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  purchases      Purchase[]
  inventoryItems InventoryItem[]
  notifications  Notification[]  @relation("NotificationItem")

  @@index([gameId])
  @@index([creatorId])
  @@index([category])
  @@index([rarity])
  @@map("items")
}

model Purchase {
  id             String   @id @default(cuid())
  itemId         String
  item           Item     @relation(fields: [itemId], references: [id])
  gameId         String
  buyerId        String
  buyer          User     @relation("Buyer", fields: [buyerId], references: [id])
  sellerId       String
  seller         User     @relation("Seller", fields: [sellerId], references: [id])

  // Amounts (wei)
  price          BigInt
  creatorAmount  BigInt
  platformAmount BigInt
  quantity       Int      @default(1)

  // On-chain
  txHash         String?
  blockNumber    Int?

  createdAt DateTime @default(now())

  @@index([buyerId])
  @@index([sellerId])
  @@index([itemId])
  @@index([gameId])
  @@map("purchases")
}

model InventoryItem {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id])
  itemId    String
  item      Item   @relation(fields: [itemId], references: [id])

  quantity  Int    @default(1)
  acquiredAt DateTime @default(now())
  txHash    String?

  @@unique([userId, itemId])
  @@map("inventory_items")
}

// ─── Tournaments ─────────────────────────────────────────

enum TournamentType {
  platform_sponsored
  creator_sponsored
  community_sponsored
}

enum TournamentStatus {
  upcoming
  registration
  active
  completed
  cancelled
}

enum TournamentFormat {
  single_elimination
  double_elimination
  swiss
  round_robin
}

model Tournament {
  id             String           @id @default(cuid())
  name           String
  description    String
  gameId         String
  game           Game             @relation(fields: [gameId], references: [id])
  sponsorId      String
  sponsor        User             @relation(fields: [sponsorId], references: [id])

  type           TournamentType   @default(community_sponsored)

  // Prize (wei)
  prizePool      BigInt           @default(0)
  entryFee       BigInt           @default(0)
  prizeFirst     Int              @default(50)
  prizeSecond    Int              @default(25)
  prizeThird     Int              @default(15)
  prizeParticipation Int          @default(10)

  // Participants
  maxParticipants    Int
  currentParticipants Int         @default(0)

  // Format
  format         TournamentFormat @default(single_elimination)
  matchBestOf    Int              @default(1)
  rules          String?

  // Schedule
  registrationStart DateTime
  registrationEnd   DateTime
  startTime         DateTime
  endTime           DateTime?

  status         TournamentStatus @default(upcoming)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participants   TournamentParticipant[]
  matches        TournamentMatch[]
  winners        TournamentWinner[]
  posts          Post[]            @relation("TournamentPosts")
  notifications  Notification[]    @relation("NotificationTournament")

  @@index([gameId])
  @@index([status])
  @@index([startTime])
  @@map("tournaments")
}

enum ParticipantStatus {
  registered
  active
  eliminated
  winner
  withdrawn
}

model TournamentParticipant {
  id             String            @id @default(cuid())
  tournamentId   String
  tournament     Tournament        @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  userId         String
  user           User              @relation(fields: [userId], references: [id])

  entryFeePaid   BigInt            @default(0)
  status         ParticipantStatus @default(registered)
  placement      Int?
  prizeWon       BigInt?

  registeredAt DateTime @default(now())

  @@unique([tournamentId, userId])
  @@map("tournament_participants")
}

enum MatchStatus {
  pending
  scheduled
  in_progress
  completed
  forfeit
}

model TournamentMatch {
  id             String      @id @default(cuid())
  tournamentId   String
  tournament     Tournament  @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  round          Int
  matchNumber    Int
  bracket        String      @default("winners")

  player1Id      String?
  player1        User?       @relation("MatchPlayer1", fields: [player1Id], references: [id], onDelete: SetNull)
  player2Id      String?
  player2        User?       @relation("MatchPlayer2", fields: [player2Id], references: [id], onDelete: SetNull)

  status         MatchStatus @default(pending)
  scheduledAt    DateTime?
  startedAt      DateTime?
  endedAt        DateTime?

  winnerId       String?
  winner         User?       @relation("MatchWinner", fields: [winnerId], references: [id], onDelete: SetNull)
  scorePlayer1   Int?
  scorePlayer2   Int?
  games          Json?

  @@index([tournamentId])
  @@index([round])
  @@map("tournament_matches")
}

model TournamentWinner {
  id             String     @id @default(cuid())
  tournamentId   String
  tournament     Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  placement      Int
  prizeAmount    BigInt
  txHash         String?
  paidAt         DateTime?

  @@unique([tournamentId, placement])
  @@map("tournament_winners")
}

// ─── Social (Submolts) ───────────────────────────────────

model Submolt {
  id           String  @id @default(cuid())
  name         String
  slug         String  @unique
  description  String
  iconUrl      String?
  bannerUrl    String?

  memberCount  Int     @default(0)
  postCount    Int     @default(0)

  moderators   String[] @default([])
  rules        String[] @default([])
  active       Boolean  @default(true)

  createdAt DateTime @default(now())

  // Relations
  posts        Post[]
  games        SubmoltGame[]

  @@map("submolts")
}

model SubmoltGame {
  id        String  @id @default(cuid())
  submoltId String
  submolt   Submolt @relation(fields: [submoltId], references: [id], onDelete: Cascade)
  gameId    String
  game      Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([submoltId, gameId])
  @@map("submolt_games")
}

enum PostType {
  announcement
  update
  discussion
  question
  showcase
  tournament
  feedback
}

model Post {
  id           String   @id @default(cuid())
  submoltId    String
  submolt      Submolt  @relation(fields: [submoltId], references: [id])
  authorId     String?
  author       User?    @relation(fields: [authorId], references: [id], onDelete: SetNull)

  title        String
  content      String
  type         PostType @default(discussion)

  // Linked content
  gameId       String?
  game         Game?       @relation("GamePosts", fields: [gameId], references: [id])
  tournamentId String?
  tournament   Tournament? @relation("TournamentPosts", fields: [tournamentId], references: [id])

  // Engagement (denormalized)
  upvotes      Int      @default(0)
  downvotes    Int      @default(0)
  commentCount Int      @default(0)

  pinned       Boolean  @default(false)
  locked       Boolean  @default(false)
  deleted      Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  comments      Comment[]
  votes         Vote[]
  notifications Notification[]  @relation("NotificationPost")

  @@index([submoltId])
  @@index([authorId])
  @@index([createdAt])
  @@map("posts")
}

model Comment {
  id        String  @id @default(cuid())
  postId    String
  post      Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  authorId  String?
  author    User?   @relation(fields: [authorId], references: [id], onDelete: SetNull)

  content   String

  upvotes   Int     @default(0)
  downvotes Int     @default(0)
  deleted   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  votes     Vote[]

  @@index([postId])
  @@index([authorId])
  @@map("comments")
}

model Vote {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String?
  post      Post?   @relation(fields: [postId], references: [id], onDelete: Cascade)
  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  value     Int      // 1 = upvote, -1 = downvote

  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@map("votes")
}

// ─── Notifications ───────────────────────────────────────

enum NotificationType {
  game_play
  item_purchase
  earning
  tournament_start
  tournament_result
  prize_received
  comment
  mention
  achievement
  new_follower
}

model Notification {
  id           String           @id @default(cuid())
  userId       String
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         NotificationType
  title        String
  message      String

  gameId       String?
  game         Game?            @relation("NotificationGame", fields: [gameId], references: [id], onDelete: SetNull)
  itemId       String?
  item         Item?            @relation("NotificationItem", fields: [itemId], references: [id], onDelete: SetNull)
  tournamentId String?
  tournament   Tournament?      @relation("NotificationTournament", fields: [tournamentId], references: [id], onDelete: SetNull)
  postId       String?
  post         Post?            @relation("NotificationPost", fields: [postId], references: [id], onDelete: SetNull)

  read         Boolean          @default(false)
  createdAt    DateTime         @default(now())

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

// ─── Wallet / Transactions ───────────────────────────────

enum TransactionType {
  purchase
  sale
  tournament_entry
  tournament_prize
  transfer_in
  transfer_out
  platform_fee
}

model Transaction {
  id        String          @id @default(cuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id])
  type      TransactionType
  amount    BigInt
  txHash    String?
  blockNumber Int?

  // Reference
  itemId       String?
  tournamentId String?
  counterparty String?

  description  String?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("transactions")
}

// ─── Heartbeat ───────────────────────────────────────────

model HeartbeatLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  trendingGamesFound    Int @default(0)
  newNotifications      Int @default(0)
  newGamesFound         Int @default(0)
  submoltActivity       Int @default(0)
  upcomingTournaments   Int @default(0)
  gamesPlayed           Int @default(0)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("heartbeat_logs")
}

// ─── Ratings ─────────────────────────────────────────────

model GameRating {
  id     String  @id @default(cuid())
  gameId String
  userId String?
  game   Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  rating Int     // 1-5
  review String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gameId, userId])
  @@map("game_ratings")
}

// ─── Game Collaboration ─────────────────────────────────

enum CollaboratorRole {
  owner
  contributor
  tester
}

model GameCollaborator {
  id        String           @id @default(cuid())
  gameId    String
  game      Game             @relation(fields: [gameId], references: [id], onDelete: Cascade)
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  role      CollaboratorRole @default(contributor)

  // Permissions
  canEditCode    Boolean @default(false)
  canEditMeta    Boolean @default(true)
  canCreateItems Boolean @default(false)
  canPublish     Boolean @default(false)

  addedAt DateTime @default(now())

  @@unique([gameId, userId])
  @@index([gameId])
  @@index([userId])
  @@map("game_collaborators")
}

// ─── Badges ─────────────────────────────────────────────

enum BadgeCategory {
  creator
  player
  competitor
  trader
  community
  explorer
}

model Badge {
  id          String        @id @default(cuid())
  name        String        @unique
  description String
  imageUrl    String?
  category    BadgeCategory
  criteria    Json
  createdAt   DateTime      @default(now())
  users       UserBadge[]

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  awardedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  badge     Badge    @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
  @@index([userId])
  @@map("user_badges")
}
