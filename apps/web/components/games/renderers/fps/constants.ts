// ==========================================================================
// FPS Renderer: Constants, sprite data, weapon/enemy defs, levels
// ==========================================================================

import type { WeaponDef, EnemyTypeDef, LevelDef } from './types';

// --------------------------------------------------------------------------
// Screen and gameplay constants
// --------------------------------------------------------------------------

export const SCREEN_W = 960;
export const SCREEN_H = 540;
export const FOV = (Math.PI * 66) / 180;
export const HALF_FOV = FOV / 2;
export const MOVE_SPEED = 3.0;
export const RUN_MULTIPLIER = 1.5;
export const TURN_SPEED = 2.0;
export const MOUSE_SENSITIVITY = 0.003;
export const PLAYER_RADIUS = 0.2;
export const PICKUP_RADIUS = 0.5;
export const EXIT_RADIUS = 0.5;
export const ENEMY_SIGHT_RANGE = 12;
export const ENEMY_AI_INTERVAL = 100; // ms between AI updates
export const KILL_FEED_DURATION = 4000; // ms
export const KILL_FEED_MAX = 4;

// Player colors for multiplayer (assigned by join order)
export const MP_PLAYER_COLORS = ['#22cc22', '#4488ff', '#aa44ff', '#ff8800'];

// --------------------------------------------------------------------------
// Glove cosmetic colors
// --------------------------------------------------------------------------

export const GLOVE_COLORS: Record<string, string> = {
  default: '#DEB887',
  tactical: '#2D2D2D',
  leather: '#8B4513',
  cyber: '#00FFFF',
  gold: '#FFD700',
  flame: '#FF4500',
  skeleton: '#FFFFFF',
};

// --------------------------------------------------------------------------
// Wall colors by map tile value
// --------------------------------------------------------------------------

export const WALL_COLORS: Record<number, [number, number, number]> = {
  1: [100, 95, 90], // stone gray (cooler)
  2: [150, 55, 40], // dark red brick
  3: [50, 65, 140], // deep blue tech
  4: [45, 110, 50], // dark green
  5: [170, 150, 50], // gold door
};

// --------------------------------------------------------------------------
// Procedural wall textures (64x64, generated once)
// Each texture is a flat Uint8Array of length 64*64*3 (RGB)
// --------------------------------------------------------------------------

export const TEX_SIZE = 64;

function clamp(v: number, min: number, max: number): number {
  return v < min ? min : v > max ? max : v;
}

function generateWallTextures(): Uint8Array[] {
  const textures: Uint8Array[] = [];

  // Helper: set pixel in texture buffer
  const setPixel = (buf: Uint8Array, x: number, y: number, r: number, g: number, b: number) => {
    if (x < 0 || x >= TEX_SIZE || y < 0 || y >= TEX_SIZE) return;
    const idx = (y * TEX_SIZE + x) * 3;
    buf[idx] = r;
    buf[idx + 1] = g;
    buf[idx + 2] = b;
  };

  // Simple seeded pseudo-random for deterministic textures
  const seedRng = (seed: number) => {
    let s = seed;
    return () => {
      s = (s * 1103515245 + 12345) & 0x7fffffff;
      return (s >>> 16) / 32768;
    };
  };

  // Texture 0: Stone/concrete (wall type 1)
  {
    const buf = new Uint8Array(TEX_SIZE * TEX_SIZE * 3);
    const rng = seedRng(42);
    for (let y = 0; y < TEX_SIZE; y++) {
      for (let x = 0; x < TEX_SIZE; x++) {
        const noise = (rng() - 0.5) * 30;
        let r = 95 + noise;
        let g = 90 + noise;
        let b = 85 + noise;
        // Grout lines (every 16 pixels, offset alternate rows)
        const brickH = 8;
        const brickW = 16;
        const rowOffset = (Math.floor(y / brickH) % 2) * (brickW / 2);
        const localX = (x + rowOffset) % brickW;
        const localY = y % brickH;
        if (localY === 0 || localX === 0) {
          r = 60 + (rng() - 0.5) * 10;
          g = 58 + (rng() - 0.5) * 10;
          b = 55 + (rng() - 0.5) * 10;
        }
        // Occasional darker spots
        if (rng() < 0.03) {
          r *= 0.7;
          g *= 0.7;
          b *= 0.7;
        }
        setPixel(
          buf,
          x,
          y,
          clamp(Math.floor(r), 0, 255),
          clamp(Math.floor(g), 0, 255),
          clamp(Math.floor(b), 0, 255),
        );
      }
    }
    textures.push(buf);
  }

  // Texture 1: Red brick (wall type 2)
  {
    const buf = new Uint8Array(TEX_SIZE * TEX_SIZE * 3);
    const rng = seedRng(137);
    for (let y = 0; y < TEX_SIZE; y++) {
      for (let x = 0; x < TEX_SIZE; x++) {
        const brickH = 8;
        const brickW = 16;
        const rowOffset = (Math.floor(y / brickH) % 2) * (brickW / 2);
        const localX = (x + rowOffset) % brickW;
        const localY = y % brickH;
        const noise = (rng() - 0.5) * 20;
        if (localY === 0 || localY === 1 || localX === 0) {
          // Mortar
          const mr = 80 + (rng() - 0.5) * 15;
          const mg = 75 + (rng() - 0.5) * 15;
          const mb = 70 + (rng() - 0.5) * 15;
          setPixel(
            buf,
            x,
            y,
            clamp(Math.floor(mr), 0, 255),
            clamp(Math.floor(mg), 0, 255),
            clamp(Math.floor(mb), 0, 255),
          );
        } else {
          // Brick face
          let r = 145 + noise;
          let g = 50 + noise * 0.4;
          const b = 35 + noise * 0.3;
          // Slight color variation per brick
          const brickId = Math.floor(y / brickH) * 4 + Math.floor((x + rowOffset) / brickW);
          const brickShift = ((brickId * 7 + 3) % 20) - 10;
          r += brickShift;
          g += brickShift * 0.3;
          setPixel(
            buf,
            x,
            y,
            clamp(Math.floor(r), 0, 255),
            clamp(Math.floor(g), 0, 255),
            clamp(Math.floor(b), 0, 255),
          );
        }
      }
    }
    textures.push(buf);
  }

  // Texture 2: Tech panel (wall type 3)
  {
    const buf = new Uint8Array(TEX_SIZE * TEX_SIZE * 3);
    const rng = seedRng(256);
    for (let y = 0; y < TEX_SIZE; y++) {
      for (let x = 0; x < TEX_SIZE; x++) {
        const noise = (rng() - 0.5) * 12;
        let r = 40 + noise;
        let g = 50 + noise;
        let b = 120 + noise;
        // Grid lines every 16 pixels
        if (x % 16 === 0 || y % 16 === 0) {
          r = 70 + noise;
          g = 85 + noise;
          b = 170 + noise;
        }
        // Panel borders (thicker lines every 32 pixels)
        if (x % 32 < 2 || y % 32 < 2) {
          r = 30;
          g = 40;
          b = 80;
        }
        // Occasional lit panels (small bright squares)
        const panelX = Math.floor(x / 16);
        const panelY = Math.floor(y / 16);
        const panelId = panelX * 5 + panelY * 3;
        if (panelId % 7 === 0) {
          const localPX = x % 16;
          const localPY = y % 16;
          if (localPX > 3 && localPX < 13 && localPY > 3 && localPY < 13) {
            r = 80 + noise;
            g = 140 + noise;
            b = 220;
          }
        }
        setPixel(
          buf,
          x,
          y,
          clamp(Math.floor(r), 0, 255),
          clamp(Math.floor(g), 0, 255),
          clamp(Math.floor(b), 0, 255),
        );
      }
    }
    textures.push(buf);
  }

  // Texture 3: Green moss / organic (wall type 4)
  {
    const buf = new Uint8Array(TEX_SIZE * TEX_SIZE * 3);
    const rng = seedRng(389);
    for (let y = 0; y < TEX_SIZE; y++) {
      for (let x = 0; x < TEX_SIZE; x++) {
        const noise1 = (rng() - 0.5) * 35;
        const noise2 = (rng() - 0.5) * 20;
        // Base organic green with color variation
        let r = 35 + noise2;
        let g = 95 + noise1;
        let b = 40 + noise2;
        // Vein-like darker lines
        const veinX = Math.sin(y * 0.3 + x * 0.1) * 8;
        if (Math.abs(((x + veinX) % 12) - 6) < 1.5) {
          r *= 0.6;
          g *= 0.7;
          b *= 0.5;
        }
        // Occasional lighter moss patches
        if (rng() < 0.05) {
          r += 20;
          g += 30;
          b += 10;
        }
        setPixel(
          buf,
          x,
          y,
          clamp(Math.floor(r), 0, 255),
          clamp(Math.floor(g), 0, 255),
          clamp(Math.floor(b), 0, 255),
        );
      }
    }
    textures.push(buf);
  }

  // Texture 4: Gold door / metallic (wall type 5)
  {
    const buf = new Uint8Array(TEX_SIZE * TEX_SIZE * 3);
    const rng = seedRng(512);
    for (let y = 0; y < TEX_SIZE; y++) {
      for (let x = 0; x < TEX_SIZE; x++) {
        const noise = (rng() - 0.5) * 15;
        let r = 160 + noise;
        let g = 140 + noise;
        let b = 45 + noise * 0.5;
        // Vertical panel lines
        if (x % 32 < 2 || x % 32 > 29) {
          r = 100;
          g = 85;
          b = 30;
        }
        // Horizontal panel lines
        if (y % 32 < 2 || y % 32 > 29) {
          r = 100;
          g = 85;
          b = 30;
        }
        // Rivet details (small circles at panel corners)
        const cornerX = x % 32;
        const cornerY = y % 32;
        if (
          (cornerX < 5 && cornerY < 5) ||
          (cornerX > 27 && cornerY < 5) ||
          (cornerX < 5 && cornerY > 27) ||
          (cornerX > 27 && cornerY > 27)
        ) {
          const cx = cornerX < 16 ? 3 : 29;
          const cy = cornerY < 16 ? 3 : 29;
          const dist = Math.sqrt((cornerX - cx) * (cornerX - cx) + (cornerY - cy) * (cornerY - cy));
          if (dist < 2.5) {
            r = 130 + (2.5 - dist) * 20;
            g = 110 + (2.5 - dist) * 15;
            b = 35;
          }
        }
        // Central metallic sheen (lighter in middle of panel)
        const midX = Math.abs((x % 32) - 16) / 16;
        const midY = Math.abs((y % 32) - 16) / 16;
        const sheen = 1 - (midX * 0.3 + midY * 0.3);
        r *= sheen;
        g *= sheen;
        b *= sheen;
        setPixel(
          buf,
          x,
          y,
          clamp(Math.floor(r), 0, 255),
          clamp(Math.floor(g), 0, 255),
          clamp(Math.floor(b), 0, 255),
        );
      }
    }
    textures.push(buf);
  }

  return textures;
}

// Lazy-generated textures (created on first use, not at module load)
let _wallTextures: Uint8Array[] | null = null;
export function getWallTextures(): Uint8Array[] {
  if (!_wallTextures) _wallTextures = generateWallTextures();
  return _wallTextures;
}

// --------------------------------------------------------------------------
// Weapon pixel art sprites and palettes
// --------------------------------------------------------------------------

// Shared weapon palette: indices map to [R, G, B]
// 0 = transparent, 1-6 = metal dark to light, 7-10 = skin tones,
// 11-13 = wood, 14-16 = accent colors, 17 = black outline
export const WEAPON_PALETTE: [number, number, number][] = [
  [0, 0, 0], // 0: transparent
  [30, 30, 35], // 1: metal darkest
  [50, 50, 55], // 2: metal dark
  [75, 75, 80], // 3: metal mid
  [100, 100, 108], // 4: metal light
  [130, 130, 140], // 5: metal highlight
  [160, 160, 175], // 6: metal brightest
  [180, 130, 90], // 7: skin dark
  [210, 160, 120], // 8: skin mid
  [230, 185, 145], // 9: skin light
  [240, 200, 165], // 10: skin highlight
  [80, 50, 25], // 11: wood dark
  [110, 70, 35], // 12: wood mid
  [140, 95, 50], // 13: wood light
  [180, 40, 30], // 14: red accent
  [50, 80, 40], // 15: olive drab
  [40, 160, 40], // 16: green glow
  [15, 15, 18], // 17: black outline
  [255, 255, 200], // 18: muzzle flash
  [60, 60, 65], // 19: dark gray detail
  [200, 180, 60], // 20: gold/brass
  [120, 100, 40], // 21: dark gold
];

// Fist sprite: 20 wide x 22 tall
const FIST_SPRITE: number[][] = [
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 17, 17, 17, 0, 17, 17, 17, 0, 17, 17, 17, 0, 0, 0, 0],
  [0, 0, 0, 0, 17, 9, 9, 9, 17, 9, 9, 9, 17, 9, 9, 9, 17, 0, 0, 0],
  [0, 0, 0, 0, 17, 9, 10, 9, 17, 9, 10, 9, 17, 9, 10, 9, 17, 0, 0, 0],
  [0, 0, 0, 0, 17, 9, 9, 9, 17, 9, 9, 9, 17, 9, 9, 9, 17, 0, 0, 0],
  [0, 0, 0, 17, 17, 8, 8, 8, 17, 8, 8, 8, 17, 8, 8, 8, 17, 17, 0, 0],
  [0, 0, 17, 9, 17, 8, 7, 8, 17, 8, 7, 8, 17, 8, 7, 8, 17, 9, 17, 0],
  [0, 0, 17, 9, 17, 8, 8, 8, 17, 8, 8, 8, 17, 8, 8, 8, 17, 9, 17, 0],
  [0, 0, 17, 10, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 10, 17, 0],
  [0, 17, 9, 10, 9, 9, 9, 9, 8, 8, 8, 8, 9, 9, 9, 9, 9, 10, 9, 17],
  [0, 17, 9, 9, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9, 17],
  [0, 17, 8, 8, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 8, 8, 8, 17],
  [0, 17, 8, 8, 8, 8, 8, 7, 7, 8, 8, 7, 7, 8, 8, 8, 8, 8, 8, 17],
  [0, 0, 17, 8, 8, 8, 7, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 17, 0],
  [0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0],
  [0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0],
  [0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0],
  [0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0],
  [0, 0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0, 0],
  [0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
];

// Pistol sprite: 24 wide x 32 tall
const PISTOL_SPRITE: number[][] = [
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 17, 17, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 1, 1, 2, 2, 1, 1, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 4, 4, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 5, 5, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 4, 4, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 3, 3, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 3, 3, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 1, 2, 2, 2, 2, 1, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 3, 3, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 19, 19, 3, 3, 19, 19, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 0, 2, 2, 0, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 0, 2, 2, 0, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 17, 2, 2, 17, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 2, 2, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 1, 1, 2, 2, 1, 1, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 17, 9, 9, 9, 8, 8, 8, 8, 8, 8, 9, 9, 17, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 17, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 17, 0, 0, 0, 0, 0],
  [0, 0, 0, 17, 10, 9, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 9, 10, 17, 0, 0, 0, 0, 0],
  [0, 0, 0, 17, 9, 9, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 9, 9, 17, 0, 0, 0, 0, 0],
  [0, 0, 17, 9, 8, 8, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 8, 8, 9, 17, 0, 0, 0, 0],
  [0, 0, 17, 8, 8, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 7, 8, 8, 17, 0, 0, 0, 0],
  [0, 0, 0, 17, 8, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 17, 0, 0, 0, 0, 0],
  [0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
];

// Shotgun sprite: 32 wide x 36 tall
const SHOTGUN_SPRITE: number[][] = [
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 3, 3, 3, 3, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 1, 17, 2, 3, 3, 2, 17, 1, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 1, 17, 2, 3, 3, 2, 17, 1, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 3, 3, 3, 3, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 3, 4, 4, 3, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 4, 5, 5, 4, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 3, 4, 4, 3, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 3, 3, 3, 3, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 3, 3, 3, 3, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 2, 3, 3, 2, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 11, 12, 12, 12, 12, 12, 12, 11, 17, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 12, 13, 11, 13, 13, 11, 13, 12, 17, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 11, 12, 13, 12, 12, 13, 12, 11, 17, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 12, 13, 11, 13, 13, 11, 13, 12, 17, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 11, 12, 12, 12, 12, 12, 12, 11, 17, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 12, 11, 12, 11, 11, 12, 11, 12, 17, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 17, 9, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 17, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 17, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 17, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 17, 10, 9, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 9, 10, 17, 0, 0, 0, 0,
    0, 0, 0, 0,
  ],
  [
    0, 0, 0, 0, 17, 9, 9, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 9, 9, 17, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 17, 9, 8, 8, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 8, 8, 9, 17, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 17, 8, 8, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 7, 8, 8, 17, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 0, 17, 8, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 17, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
  ],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
];

// Chaingun sprite: 28 wide x 36 tall
const CHAINGUN_SPRITE: number[][] = [
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 17, 0, 0, 0, 0, 17, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 17, 0, 0, 17, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 1, 2, 17, 0, 0, 17, 2, 1, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 3, 17, 0, 0, 17, 3, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 3, 17, 17, 17, 17, 3, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 3, 3, 4, 3, 3, 3, 3, 4, 3, 3, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 4, 4, 4, 4, 4, 4, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 3, 4, 5, 5, 4, 3, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 17, 19, 2, 2, 3, 3, 4, 4, 3, 3, 2, 2, 19, 17, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 17, 19, 2, 2, 3, 3, 3, 3, 3, 3, 2, 2, 19, 17, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 2, 2, 3, 3, 3, 3, 2, 2, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 2, 2, 2, 3, 3, 2, 2, 2, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 17, 20, 20, 2, 2, 2, 2, 2, 2, 2, 2, 20, 20, 17, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 17, 21, 20, 2, 2, 2, 2, 2, 2, 2, 2, 20, 21, 17, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 17, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 17, 0, 0, 0, 0, 0, 0, 0],
  [
    0, 0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0, 0,
    0,
  ],
  [0, 0, 0, 0, 0, 17, 9, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 9, 17, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 17, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 17, 0, 0, 0, 0],
  [0, 0, 0, 17, 10, 9, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 9, 10, 17, 0, 0, 0, 0, 0],
  [0, 0, 0, 17, 9, 9, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 9, 9, 17, 0, 0, 0, 0, 0],
  [0, 0, 17, 9, 8, 8, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 8, 8, 9, 17, 0, 0, 0, 0],
  [0, 0, 17, 8, 8, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 7, 8, 8, 17, 0, 0, 0, 0],
  [0, 0, 0, 17, 8, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 17, 0, 0, 0, 0, 0],
  [0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0, 0, 0, 0, 0],
  [
    0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
];

// Rocket Launcher sprite: 30 wide x 36 tall
const ROCKET_SPRITE: number[][] = [
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 17, 17, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 3, 4, 4, 3, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 15, 15, 15, 15, 15, 15, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 15, 15, 15, 15, 15, 15, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 17, 15, 15, 15, 15, 15, 15, 17, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 15, 15, 15, 15, 15, 15, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 15, 15, 15, 15, 15, 15, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 15, 15, 15, 15, 15, 15, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 19, 15, 15, 15, 15, 15, 15, 19, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 15, 15, 15, 15, 15, 15, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 15, 15, 15, 15, 15, 15, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 19, 15, 15, 15, 15, 15, 15, 19, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 15, 15, 15, 15, 15, 15, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 15, 15, 15, 15, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 2, 2, 2, 2, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 1, 2, 2, 2, 2, 2, 2, 1, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 1, 1, 2, 2, 2, 2, 1, 1, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [
    0, 0, 0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [0, 0, 0, 0, 0, 0, 17, 9, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 17, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 17, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 17, 0, 0, 0, 0, 0],
  [
    0, 0, 0, 0, 17, 10, 9, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 9, 10, 17, 0, 0, 0, 0,
    0, 0,
  ],
  [
    0, 0, 0, 0, 17, 9, 9, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 9, 9, 17, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 17, 9, 8, 8, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 8, 8, 9, 17, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 17, 8, 8, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 7, 8, 8, 17, 0, 0, 0, 0,
    0,
  ],
  [0, 0, 0, 0, 17, 8, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 17, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0, 0, 0, 0, 0, 0],
  [
    0, 0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
];

// BFG sprite: 32 wide x 36 tall
const BFG_SPRITE: number[][] = [
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 16, 16, 16, 16, 16, 16, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 16, 16, 18, 18, 18, 18, 18, 16, 16, 16, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 16, 16, 18, 18, 18, 18, 18, 18, 18, 16, 16, 16, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 16, 18, 18, 16, 16, 16, 16, 16, 18, 18, 16, 16, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 17, 2, 2, 2, 2, 2, 2, 2, 2, 2, 17, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 3, 3, 3, 4, 4, 4, 4, 3, 3, 3, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 3, 16, 16, 16, 16, 16, 16, 16, 3, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 16, 16, 16, 16, 16, 16, 16, 16, 16, 3, 2, 17, 0, 0, 0, 0, 0, 0,
    0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 17, 2, 3, 3, 16, 16, 16, 16, 16, 16, 16, 3, 3, 2, 17, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 3, 3, 3, 4, 4, 4, 4, 3, 3, 3, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 1, 1, 2, 2, 2, 2, 2, 2, 1, 1, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 1, 1, 1, 2, 2, 2, 2, 1, 1, 1, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
  ],
  [
    0, 0, 0, 0, 0, 0, 17, 9, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 17, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 17, 9, 9, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 17, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 17, 10, 9, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 9, 10, 17, 0, 0, 0, 0,
    0, 0, 0, 0,
  ],
  [
    0, 0, 0, 0, 17, 9, 9, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 17, 8, 9, 9, 17, 0, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 17, 9, 8, 8, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 8, 8, 9, 17, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 17, 8, 8, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 17, 7, 7, 8, 8, 17, 0, 0, 0, 0,
    0, 0, 0,
  ],
  [
    0, 0, 0, 0, 17, 8, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 17, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 17, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 17, 0, 0, 0, 0, 0, 0, 0, 0,
    0,
  ],
  [
    0, 0, 0, 0, 0, 0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0,
  ],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
];

// All weapon sprites indexed by weapon slot
export const WEAPON_SPRITES: number[][][] = [
  FIST_SPRITE,
  PISTOL_SPRITE,
  SHOTGUN_SPRITE,
  CHAINGUN_SPRITE,
  ROCKET_SPRITE,
  BFG_SPRITE,
];

// --------------------------------------------------------------------------
// Enemy pixel art sprites and palettes
// --------------------------------------------------------------------------

// Enemy palettes: each type has its own color ramp
// Index 0 = transparent, indices 1-8 from darkest to brightest, 9 = eye color
export const ENEMY_PALETTES: Record<string, [number, number, number][]> = {
  grunt: [
    [0, 0, 0], // 0: transparent
    [30, 18, 8], // 1: darkest brown (outline)
    [65, 40, 20], // 2: dark brown
    [100, 65, 30], // 3: mid brown
    [130, 85, 42], // 4: brown
    [155, 105, 55], // 5: light brown
    [175, 130, 80], // 6: lightest brown
    [200, 155, 100], // 7: highlight
    [40, 15, 10], // 8: very dark (belt/detail)
    [220, 40, 40], // 9: red eyes
  ],
  soldier: [
    [0, 0, 0], // 0: transparent
    [20, 22, 30], // 1: darkest blue-gray (outline)
    [45, 50, 60], // 2: dark blue-gray
    [70, 78, 95], // 3: mid blue-gray
    [95, 105, 125], // 4: blue-gray
    [115, 125, 145], // 5: light blue-gray
    [140, 150, 170], // 6: lightest
    [170, 180, 200], // 7: highlight
    [30, 30, 35], // 8: very dark (belt/detail)
    [200, 200, 40], // 9: yellow visor
  ],
  heavy: [
    [0, 0, 0], // 0: transparent
    [40, 8, 8], // 1: darkest red (outline)
    [80, 18, 18], // 2: dark red
    [120, 30, 28], // 3: mid red
    [155, 40, 35], // 4: red
    [180, 55, 45], // 5: light red
    [200, 80, 65], // 6: lightest
    [220, 110, 90], // 7: highlight
    [25, 5, 5], // 8: very dark (horns)
    [255, 180, 40], // 9: orange eyes
  ],
  boss: [
    [0, 0, 0], // 0: transparent
    [50, 5, 5], // 1: darkest crimson (outline)
    [90, 12, 12], // 2: dark crimson
    [140, 20, 18], // 3: mid crimson
    [180, 28, 25], // 4: crimson
    [210, 40, 35], // 5: light crimson
    [230, 65, 55], // 6: lightest
    [245, 100, 85], // 7: highlight
    [20, 2, 2], // 8: very dark (crown/wings)
    [255, 20, 20], // 9: glowing red eyes
  ],
};

// Grunt sprite: 16 wide x 20 tall
const GRUNT_SPRITE: number[][] = [
  [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 4, 5, 5, 5, 5, 4, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 5, 6, 6, 6, 6, 5, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 5, 9, 5, 5, 9, 5, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 4, 4, 5, 5, 4, 4, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 4, 3, 3, 4, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0],
  [0, 0, 1, 1, 1, 1, 3, 4, 4, 3, 1, 1, 1, 1, 0, 0],
  [0, 1, 3, 3, 1, 3, 4, 5, 5, 4, 3, 1, 3, 3, 1, 0],
  [0, 1, 2, 3, 1, 4, 5, 5, 5, 5, 4, 1, 3, 2, 1, 0],
  [0, 1, 2, 3, 1, 4, 4, 5, 5, 4, 4, 1, 3, 2, 1, 0],
  [0, 0, 1, 1, 1, 3, 4, 4, 4, 4, 3, 1, 1, 1, 0, 0],
  [0, 0, 0, 0, 1, 8, 8, 3, 3, 8, 8, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 3, 4, 4, 3, 3, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 3, 3, 3, 3, 3, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 3, 3, 3, 3, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 2, 3, 3, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 3, 1, 1, 3, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0],
];

// Soldier sprite: 16 wide x 22 tall
const SOLDIER_SPRITE: number[][] = [
  [0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0],
  [0, 0, 0, 1, 2, 2, 3, 3, 3, 3, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 1, 3, 4, 4, 4, 4, 4, 4, 3, 1, 0, 0, 0],
  [0, 0, 0, 1, 3, 9, 3, 4, 4, 3, 9, 3, 1, 0, 0, 0],
  [0, 0, 0, 1, 3, 3, 4, 4, 4, 4, 3, 3, 1, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 3, 2, 2, 3, 3, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
  [0, 1, 1, 1, 1, 3, 4, 5, 5, 4, 3, 1, 1, 1, 1, 0],
  [1, 3, 2, 1, 3, 4, 5, 5, 5, 5, 4, 3, 1, 2, 3, 1],
  [1, 2, 3, 1, 4, 5, 5, 6, 6, 5, 5, 4, 1, 3, 2, 1],
  [0, 1, 3, 1, 4, 4, 5, 5, 5, 5, 4, 4, 1, 3, 1, 0],
  [0, 0, 1, 1, 3, 4, 4, 5, 5, 4, 4, 3, 1, 1, 0, 0],
  [0, 0, 0, 1, 8, 8, 8, 8, 8, 8, 8, 8, 1, 0, 0, 0],
  [0, 0, 0, 1, 3, 3, 4, 4, 4, 4, 3, 3, 1, 0, 0, 0],
  [0, 0, 0, 1, 3, 3, 3, 4, 4, 3, 3, 3, 1, 0, 0, 0],
  [0, 0, 0, 1, 2, 3, 3, 3, 3, 3, 3, 2, 1, 0, 0, 0],
  [0, 0, 0, 1, 2, 2, 3, 3, 3, 3, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 1, 2, 2, 2, 3, 3, 2, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0],
  [0, 0, 0, 1, 2, 3, 3, 1, 1, 3, 3, 2, 1, 0, 0, 0],
  [0, 0, 0, 1, 2, 2, 3, 1, 1, 3, 2, 2, 1, 0, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0],
];

// Heavy sprite: 18 wide x 24 tall
const HEAVY_SPRITE: number[][] = [
  [0, 0, 0, 0, 0, 1, 8, 8, 1, 0, 1, 8, 8, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 8, 1, 0, 1, 8, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 1, 3, 4, 4, 4, 3, 1, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 4, 5, 5, 5, 5, 5, 4, 3, 1, 0, 0, 0],
  [0, 0, 0, 0, 1, 4, 9, 4, 5, 5, 4, 9, 4, 4, 1, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 3, 4, 4, 4, 4, 3, 3, 3, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 3, 2, 3, 3, 2, 3, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0],
  [0, 1, 1, 1, 1, 1, 3, 4, 5, 5, 4, 3, 1, 1, 1, 1, 1, 0],
  [1, 2, 3, 3, 1, 3, 4, 5, 6, 6, 5, 4, 3, 1, 3, 3, 2, 1],
  [1, 2, 2, 3, 1, 4, 5, 6, 6, 6, 6, 5, 4, 1, 3, 2, 2, 1],
  [1, 1, 2, 3, 1, 4, 5, 5, 6, 6, 5, 5, 4, 1, 3, 2, 1, 1],
  [0, 1, 2, 3, 1, 3, 4, 5, 5, 5, 5, 4, 3, 1, 3, 2, 1, 0],
  [0, 0, 1, 1, 1, 3, 4, 4, 5, 5, 4, 4, 3, 1, 1, 1, 0, 0],
  [0, 0, 0, 0, 1, 8, 8, 8, 3, 3, 8, 8, 8, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 3, 4, 4, 4, 4, 3, 3, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 3, 3, 4, 4, 3, 3, 3, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 3, 3, 3, 3, 3, 3, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 2, 3, 3, 3, 3, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 3, 3, 1, 1, 3, 3, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 2, 3, 1, 1, 3, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0],
];

// Boss sprite: 20 wide x 28 tall
const BOSS_SPRITE: number[][] = [
  [0, 0, 0, 1, 8, 1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 8, 1, 0, 0, 0],
  [0, 0, 0, 0, 1, 8, 1, 0, 1, 8, 8, 1, 0, 1, 8, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 8, 1, 8, 8, 8, 8, 1, 8, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 1, 3, 4, 5, 5, 4, 3, 1, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 4, 5, 6, 6, 6, 6, 5, 4, 3, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 4, 9, 5, 6, 7, 7, 6, 5, 9, 4, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 4, 5, 5, 5, 5, 5, 5, 4, 3, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 3, 3, 4, 4, 4, 4, 3, 3, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0],
  [1, 8, 1, 1, 1, 1, 3, 4, 5, 6, 6, 5, 4, 3, 1, 1, 1, 1, 8, 1],
  [0, 1, 8, 1, 1, 3, 4, 5, 6, 7, 7, 6, 5, 4, 3, 1, 1, 8, 1, 0],
  [0, 0, 1, 8, 1, 4, 5, 6, 7, 7, 7, 7, 6, 5, 4, 1, 8, 1, 0, 0],
  [0, 0, 0, 1, 1, 4, 5, 6, 6, 7, 7, 6, 6, 5, 4, 1, 1, 0, 0, 0],
  [0, 0, 0, 1, 3, 4, 5, 5, 6, 6, 6, 6, 5, 5, 4, 3, 1, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 4, 5, 5, 6, 6, 5, 5, 4, 3, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 8, 8, 8, 8, 3, 3, 8, 8, 8, 8, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 3, 4, 4, 5, 5, 4, 4, 3, 3, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 3, 3, 3, 4, 4, 4, 4, 3, 3, 3, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 3, 3, 3, 4, 4, 3, 3, 3, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 2, 3, 3, 3, 3, 3, 3, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 2, 2, 3, 3, 3, 3, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 3, 3, 3, 1, 1, 3, 3, 3, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 2, 3, 3, 1, 1, 3, 3, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 2, 2, 2, 3, 1, 1, 3, 2, 2, 2, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 1, 2, 2, 3, 1, 1, 3, 2, 2, 1, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
];

export const ENEMY_SPRITES: Record<string, number[][]> = {
  grunt: GRUNT_SPRITE,
  soldier: SOLDIER_SPRITE,
  heavy: HEAVY_SPRITE,
  boss: BOSS_SPRITE,
};

// --------------------------------------------------------------------------
// Star field positions (deterministic, generated once)
// --------------------------------------------------------------------------

let _starField: { x: number; y: number; size: number; alpha: number }[] | null = null;
export function getStarField(): { x: number; y: number; size: number; alpha: number }[] {
  if (!_starField) {
    _starField = [];
    for (let i = 0; i < 40; i++) {
      const sx = (i * 137 + 53) % SCREEN_W;
      const sy = (i * 97 + 29) % Math.floor(SCREEN_H / 3);
      const sz = i % 4 === 0 ? 2 : 1;
      const sa = 0.08 + ((i * 31) % 10) / 80;
      _starField.push({ x: sx, y: sy, size: sz, alpha: sa });
    }
  }
  return _starField;
}

// --------------------------------------------------------------------------
// Weapon definitions
// --------------------------------------------------------------------------

// NOTE: These weapon stats are renderer-specific. The game-builder FPSGame.ts
// has different values for session scoring. This is intentional: the thin
// template pattern separates real-time gameplay (renderer) from session state
// (game-builder).
export const WEAPONS: WeaponDef[] = [
  {
    name: 'Fist',
    damage: 10,
    fireRate: 400,
    range: 1.5,
    ammoType: null,
    ammoPerShot: 0,
    startAmmo: 0,
    maxAmmo: 0,
    spread: 0,
  },
  {
    name: 'Pistol',
    damage: 15,
    fireRate: 350,
    range: 20,
    ammoType: 'bullets',
    ammoPerShot: 1,
    startAmmo: 30,
    maxAmmo: 100,
    spread: 0.01,
  },
  {
    name: 'Shotgun',
    damage: 60,
    fireRate: 800,
    range: 8,
    ammoType: 'shells',
    ammoPerShot: 1,
    startAmmo: 8,
    maxAmmo: 50,
    spread: 0.08,
  },
  {
    name: 'Chaingun',
    damage: 12,
    fireRate: 80,
    range: 18,
    ammoType: 'bullets',
    ammoPerShot: 1,
    startAmmo: 50,
    maxAmmo: 200,
    spread: 0.04,
  },
  {
    name: 'Rocket Launcher',
    damage: 100,
    fireRate: 1200,
    range: 30,
    ammoType: 'rockets',
    ammoPerShot: 1,
    startAmmo: 5,
    maxAmmo: 30,
    spread: 0,
  },
  {
    name: 'BFG',
    damage: 200,
    fireRate: 2000,
    range: 40,
    ammoType: 'cells',
    ammoPerShot: 10,
    startAmmo: 40,
    maxAmmo: 100,
    spread: 0,
  },
];

// --------------------------------------------------------------------------
// Enemy type definitions
// --------------------------------------------------------------------------

export const ENEMY_TYPES: Record<string, EnemyTypeDef> = {
  grunt: {
    health: 30,
    damage: 5,
    speed: 1.2,
    attackRange: 1.5,
    attackRate: 1000,
    score: 50,
    color: [139, 90, 43],
    width: 1,
    height: 1,
  },
  soldier: {
    health: 60,
    damage: 10,
    speed: 1.5,
    attackRange: 10,
    attackRate: 800,
    score: 100,
    color: [100, 110, 130],
    width: 1,
    height: 1,
  },
  heavy: {
    health: 120,
    damage: 20,
    speed: 0.8,
    attackRange: 6,
    attackRate: 1500,
    score: 200,
    color: [160, 40, 40],
    width: 1.3,
    height: 1.2,
  },
  boss: {
    health: 500,
    damage: 30,
    speed: 1.0,
    attackRange: 8,
    attackRate: 1200,
    score: 1000,
    color: [200, 30, 30],
    width: 1.8,
    height: 1.5,
  },
};

// --------------------------------------------------------------------------
// Level data
// --------------------------------------------------------------------------

// Level 1: Training Facility (16x16)
const LEVEL_1: LevelDef = {
  name: 'Training Facility',
  map: [
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
    [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
    [1, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 1, 0, 0, 1],
    [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1],
    [1, 0, 0, 0, 0, 0, 1, 1, 1, 5, 1, 1, 1, 0, 0, 1],
    [1, 1, 5, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1],
    [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 1],
    [1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 1, 1, 1, 1],
    [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
    [1, 0, 0, 1, 1, 5, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1],
    [1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 5, 1, 1, 1],
    [1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1],
    [1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1],
    [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
  ],
  playerStart: [1.5, 1.5],
  playerAngle: 0,
  exitPos: [14.5, 13.5],
  enemies: [
    { type: 'grunt', x: 4.5, y: 3.5 },
    { type: 'grunt', x: 8.5, y: 2.5 },
    { type: 'grunt', x: 8.5, y: 8.5 },
    { type: 'grunt', x: 2.5, y: 9.5 },
    { type: 'grunt', x: 13.5, y: 2.5 },
  ],
  pickups: [
    { type: 'health', x: 1.5, y: 8.5, value: 25 },
    { type: 'ammo_bullets', x: 5.5, y: 1.5, value: 15 },
    { type: 'ammo_bullets', x: 9.5, y: 9.5, value: 15 },
    { type: 'weapon_shotgun', x: 5.5, y: 12.5, value: 0, weaponName: 'Shotgun' },
    { type: 'health', x: 13.5, y: 7.5, value: 25 },
  ],
  secrets: [{ x: 5.5, y: 12.5 }],
};

// Level 2: Demon Base (20x20)
const LEVEL_2: LevelDef = {
  name: 'Demon Base',
  map: [
    [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
    [2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 5, 0, 0, 3, 3, 3, 3, 0, 0, 5, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 2, 0, 0, 3, 0, 0, 3, 0, 0, 2, 0, 0, 0, 0, 2],
    [2, 2, 2, 5, 2, 2, 0, 0, 3, 0, 0, 3, 0, 0, 2, 2, 5, 2, 2, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 2],
    [2, 0, 0, 4, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 4, 0, 0, 2],
    [2, 0, 0, 4, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 4, 0, 0, 2],
    [2, 0, 0, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 2, 2, 5, 2, 2, 0, 0, 3, 0, 0, 3, 0, 0, 2, 2, 5, 2, 2, 2],
    [2, 0, 0, 0, 0, 2, 0, 0, 3, 0, 0, 3, 0, 0, 2, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 5, 0, 0, 3, 3, 3, 3, 0, 0, 5, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2],
    [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
  ],
  playerStart: [1.5, 1.5],
  playerAngle: Math.PI / 4,
  exitPos: [18.5, 18.5],
  enemies: [
    { type: 'grunt', x: 3.5, y: 7.5 },
    { type: 'grunt', x: 16.5, y: 7.5 },
    { type: 'soldier', x: 9.5, y: 5.5 },
    { type: 'soldier', x: 10.5, y: 5.5 },
    { type: 'grunt', x: 1.5, y: 15.5 },
    { type: 'grunt', x: 18.5, y: 15.5 },
    { type: 'soldier', x: 9.5, y: 12.5 },
    { type: 'soldier', x: 10.5, y: 12.5 },
    { type: 'heavy', x: 9.5, y: 9.5 },
    { type: 'grunt', x: 3.5, y: 17.5 },
  ],
  pickups: [
    { type: 'health', x: 2.5, y: 2.5, value: 25 },
    { type: 'armor', x: 17.5, y: 2.5, value: 30 },
    { type: 'ammo_bullets', x: 7.5, y: 1.5, value: 20 },
    { type: 'ammo_shells', x: 12.5, y: 1.5, value: 10 },
    { type: 'weapon_chaingun', x: 4.5, y: 9.5, value: 0, weaponName: 'Chaingun' },
    { type: 'health', x: 15.5, y: 9.5, value: 50 },
    { type: 'ammo_bullets', x: 9.5, y: 18.5, value: 30 },
    { type: 'armor', x: 1.5, y: 18.5, value: 30 },
    { type: 'health', x: 18.5, y: 1.5, value: 25 },
  ],
  secrets: [
    { x: 4.5, y: 9.5 },
    { x: 15.5, y: 9.5 },
  ],
};

// Level 3: Boss Arena (20x20)
const LEVEL_3: LevelDef = {
  name: 'Boss Arena',
  map: [
    [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
    [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
  ],
  playerStart: [1.5, 18.5],
  playerAngle: -Math.PI / 4,
  exitPos: [18.5, 1.5],
  enemies: [
    { type: 'boss', x: 10, y: 10 },
    { type: 'soldier', x: 5.5, y: 5.5 },
    { type: 'soldier', x: 14.5, y: 5.5 },
    { type: 'soldier', x: 5.5, y: 14.5 },
    { type: 'soldier', x: 14.5, y: 14.5 },
    { type: 'grunt', x: 10, y: 3.5 },
  ],
  pickups: [
    { type: 'weapon_rocket', x: 10, y: 17.5, value: 0, weaponName: 'Rocket Launcher' },
    { type: 'health', x: 1.5, y: 1.5, value: 50 },
    { type: 'health', x: 18.5, y: 18.5, value: 50 },
    { type: 'armor', x: 18.5, y: 1.5, value: 50 },
    { type: 'ammo_rockets', x: 1.5, y: 10, value: 5 },
    { type: 'ammo_rockets', x: 18.5, y: 10, value: 5 },
    { type: 'ammo_bullets', x: 10, y: 1.5, value: 30 },
    { type: 'ammo_shells', x: 10, y: 18.5, value: 10 },
    { type: 'health', x: 10, y: 5, value: 25 },
    { type: 'health', x: 10, y: 15, value: 25 },
  ],
  secrets: [],
};

// Level 4: The Vault (secret level, requires marketplace key)
const LEVEL_4: LevelDef = {
  name: 'The Vault',
  map: [
    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
    [3, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 3],
    [3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3],
    [3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3],
    [3, 0, 3, 3, 3, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3],
    [3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3],
    [3, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 3],
    [3, 5, 0, 0, 0, 0, 4, 0, 0, 4, 0, 0, 0, 0, 5, 3],
    [3, 0, 0, 0, 0, 0, 4, 0, 0, 4, 0, 0, 0, 0, 0, 3],
    [3, 0, 0, 0, 0, 0, 4, 4, 5, 4, 0, 0, 0, 0, 0, 3],
    [3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3],
    [3, 0, 3, 3, 3, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3],
    [3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3],
    [3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3],
    [3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3],
    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
  ],
  playerStart: [1.5, 14.5],
  playerAngle: -Math.PI / 2,
  exitPos: [14.5, 1.5],
  enemies: [
    { type: 'heavy', x: 7.5, y: 7.5 },
    { type: 'heavy', x: 8.5, y: 8.5 },
    { type: 'soldier', x: 3.5, y: 3.5 },
    { type: 'soldier', x: 12.5, y: 3.5 },
    { type: 'soldier', x: 3.5, y: 12.5 },
    { type: 'soldier', x: 12.5, y: 12.5 },
    { type: 'boss', x: 7.5, y: 1.5 },
  ],
  pickups: [
    { type: 'weapon_rocket', x: 1.5, y: 7.5, value: 0, weaponName: 'Rocket Launcher' },
    { type: 'weapon_bfg', x: 14.5, y: 7.5, value: 0, weaponName: 'BFG' },
    { type: 'health', x: 7.5, y: 14.5, value: 50 },
    { type: 'health', x: 8.5, y: 14.5, value: 50 },
    { type: 'armor', x: 7.5, y: 5.5, value: 50 },
    { type: 'ammo_rockets', x: 4.5, y: 7.5, value: 10 },
    { type: 'ammo_cells', x: 11.5, y: 7.5, value: 30 },
    { type: 'ammo_bullets', x: 7.5, y: 10.5, value: 50 },
  ],
  secrets: [{ x: 7.5, y: 7.5 }],
};

export const LEVELS: LevelDef[] = [LEVEL_1, LEVEL_2, LEVEL_3, LEVEL_4];

// --------------------------------------------------------------------------
// Utility functions (shared across modules)
// --------------------------------------------------------------------------

export function dist(x1: number, y1: number, x2: number, y2: number): number {
  const dx = x2 - x1;
  const dy = y2 - y1;
  return Math.sqrt(dx * dx + dy * dy);
}

export { clamp };

export function darkenRGB(
  r: number,
  g: number,
  b: number,
  factor: number,
): [number, number, number] {
  return [Math.floor(r * factor), Math.floor(g * factor), Math.floor(b * factor)];
}

// Check line of sight between two points on the map
export function hasLineOfSight(
  x1: number,
  y1: number,
  x2: number,
  y2: number,
  map: number[][],
  mapWidth: number,
  mapHeight: number,
): boolean {
  const dx = x2 - x1;
  const dy = y2 - y1;
  const distance = Math.sqrt(dx * dx + dy * dy);
  const steps = Math.ceil(distance * 4);
  for (let i = 0; i <= steps; i++) {
    const t = i / steps;
    const cx = x1 + dx * t;
    const cy = y1 + dy * t;
    const mx = Math.floor(cx);
    const my = Math.floor(cy);
    if (mx < 0 || mx >= mapWidth || my < 0 || my >= mapHeight) return false;
    if (map[my][mx] > 0) return false;
  }
  return true;
}

// Spawn particles at a screen position
export function spawnParticles(
  particles: import('./types').Particle[],
  x: number,
  y: number,
  count: number,
  color: string,
  speedRange: number,
  lifeRange: number,
  sizeRange: number,
): void {
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = Math.random() * speedRange + speedRange * 0.3;
    particles.push({
      x,
      y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - Math.random() * 2,
      life: lifeRange * (0.5 + Math.random() * 0.5),
      maxLife: lifeRange,
      color,
      size: 1 + Math.random() * sizeRange,
    });
  }
}

// --------------------------------------------------------------------------
// Pixel sprite drawing utility
// --------------------------------------------------------------------------

export function drawPixelSprite(
  ctx: CanvasRenderingContext2D,
  spriteData: number[][],
  palette: [number, number, number][],
  x: number,
  y: number,
  pixelSize: number,
  fogFactor?: number,
  gloveColorOverride?: Record<number, [number, number, number]>,
): void {
  const fog = fogFactor ?? 1;
  for (let row = 0; row < spriteData.length; row++) {
    const rowData = spriteData[row];
    for (let col = 0; col < rowData.length; col++) {
      const palIdx = rowData[col];
      if (palIdx === 0) continue; // transparent
      let color = palette[palIdx];
      if (!color) continue;
      // Apply glove color override for skin tone indices
      if (gloveColorOverride && gloveColorOverride[palIdx]) {
        color = gloveColorOverride[palIdx];
      }
      const r = Math.floor(color[0] * fog);
      const g = Math.floor(color[1] * fog);
      const b = Math.floor(color[2] * fog);
      ctx.fillStyle = `rgb(${r},${g},${b})`;
      ctx.fillRect(
        Math.floor(x + col * pixelSize),
        Math.floor(y + row * pixelSize),
        pixelSize,
        pixelSize,
      );
    }
  }
}

// Multiplayer: get WebSocket URL
export function getWsUrl(): string {
  if (typeof window === 'undefined') return '';
  const apiUrl = process.env.NEXT_PUBLIC_API_URL || '';
  if (apiUrl) {
    try {
      const url = new URL(apiUrl);
      const protocol = url.protocol === 'https:' ? 'wss:' : 'ws:';
      return `${protocol}//${url.host}`;
    } catch {
      // fall through to window.location
    }
  }
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const host = window.location.hostname;
  const port = window.location.hostname === 'localhost' ? ':3001' : '';
  return `${protocol}//${host}${port}`;
}

// --------------------------------------------------------------------------
// Build initial game state from a level
// NOTE: Renderer uses 0-indexed levels, game-builder uses 1-indexed.
// This is intentional as they operate independently.
// --------------------------------------------------------------------------

export function buildLevelState(
  levelIndex: number,
  carryOver?: {
    health: number;
    armor: number;
    weapons: import('./types').WeaponState[];
    score: number;
    kills: number;
    secretsFound: number;
    gameTime: number;
  },
  gloveColor?: string,
  configOptions?: {
    ownedWeapons?: string[];
    secretLevelUnlocked?: boolean;
    consumables?: { type: string; count: number }[];
    multiplayer?: boolean;
    matchId?: string;
    difficulty?: string;
    killsToWin?: number;
  },
): import('./types').FPSGameState {
  const actualIndex = Math.min(levelIndex, LEVELS.length - 1);
  const level = LEVELS[actualIndex];
  const map = level.map.map((row) => [...row]);
  const mapHeight = map.length;
  const mapWidth = map[0].length;

  const difficultyMult =
    configOptions?.difficulty === 'easy' ? 0.7 : configOptions?.difficulty === 'hard' ? 1.5 : 1.0;

  const weapons: import('./types').WeaponState[] = WEAPONS.map((w, i) => ({
    name: w.name,
    owned: i <= 1, // fist and pistol owned by default
    ammo: w.ammoType === null ? Infinity : w.startAmmo,
    maxAmmo: w.maxAmmo,
    damage: w.damage,
    fireRate: w.fireRate,
    ammoType: w.ammoType,
    ammoPerShot: w.ammoPerShot,
    range: w.range,
    spread: w.spread,
  }));

  const enemies: import('./types').EnemyState[] = level.enemies.map((e, i) => {
    const def = ENEMY_TYPES[e.type];
    return {
      id: i,
      x: e.x,
      y: e.y,
      health: Math.floor(def.health * difficultyMult),
      maxHealth: Math.floor(def.health * difficultyMult),
      type: e.type,
      state: 'idle' as const,
      alive: true,
      lastAttack: 0,
      alertTimer: 0,
      lostSightTimer: 0,
    };
  });

  const pickups: import('./types').PickupState[] = level.pickups.map((p, i) => ({
    id: i,
    x: p.x,
    y: p.y,
    type: p.type,
    value: p.value,
    collected: false,
    weaponName: p.weaponName,
  }));

  const secrets: import('./types').SecretState[] = level.secrets.map((s) => ({
    x: s.x,
    y: s.y,
    found: false,
  }));

  // Parse consumables from config
  const consumables: import('./types').ConsumableState[] = [];
  let extraLives = 0;
  if (configOptions?.consumables) {
    for (const c of configOptions.consumables) {
      if (c.type === 'extra_life') {
        extraLives = c.count;
      } else {
        consumables.push({ type: c.type, count: c.count });
      }
    }
  }

  const ownedWeapons = configOptions?.ownedWeapons || [];
  const secretLevelUnlocked = configOptions?.secretLevelUnlocked || false;
  const isMultiplayer = configOptions?.multiplayer || false;

  const state: import('./types').FPSGameState = {
    playerX: level.playerStart[0],
    playerY: level.playerStart[1],
    playerAngle: level.playerAngle,
    playerHealth: carryOver ? carryOver.health : 100,
    playerArmor: carryOver ? carryOver.armor : 0,
    weapons: carryOver ? carryOver.weapons.map((w) => ({ ...w })) : weapons,
    currentWeapon: 1,
    enemies,
    pickups,
    map,
    mapWidth,
    mapHeight,
    level: actualIndex,
    exitX: level.exitPos[0],
    exitY: level.exitPos[1],
    secrets,
    score: carryOver ? carryOver.score : 0,
    kills: carryOver ? carryOver.kills : 0,
    secretsFound: carryOver ? carryOver.secretsFound : 0,
    totalSecrets: secrets.length + (carryOver ? carryOver.secretsFound : 0),
    gameTime: carryOver ? carryOver.gameTime : 0,
    message: `Level ${actualIndex + 1}: ${level.name}`,
    messageTimer: 3000,
    screenFlash: null,
    flashTimer: 0,
    weaponBob: 0,
    weaponRecoil: 0,
    lastShotTime: 0,
    gameOver: false,
    victory: false,
    levelTransition: false,
    levelTransitionTimer: 0,
    gloveColor: gloveColor || 'default',
    lastEnemyAIUpdate: 0,
    // Particle system
    particles: [],
    // Kill feed
    killFeed: [],
    // Screen shake
    shakeTimer: 0,
    shakeIntensity: 0,
    // Damage vignette
    damageVignetteTimer: 0,
    // Pickup flash
    pickupFlashColor: null,
    pickupFlashTimer: 0,
    // Consumables
    consumables,
    damageBoostTimer: 0,
    invincibilityTimer: 0,
    extraLives,
    // Multiplayer
    multiplayerMode: isMultiplayer,
    matchId: configOptions?.matchId || null,
    matchStatus: isMultiplayer ? 'connecting' : 'playing',
    countdownSeconds: 0,
    wsRef: null,
    remotePlayers: new Map(),
    localPlayerId: '',
    matchScores: {},
    killsToWin: configOptions?.killsToWin || 10,
    lastNetworkUpdate: 0,
    mpWaitingPlayers: 0,
    mpMaxPlayers: 4,
    mpReady: false,
    mpWinnerId: null,
    mpKilledBy: null,
    mpRespawnTimer: 0,
    mpMatchDuration: 0,
    // Marketplace
    ownedWeapons,
    secretLevelUnlocked,
    maxLevel: secretLevelUnlocked ? 3 : 2, // 0-indexed: levels 0,1,2 base + level 3 if unlocked
    // Per-frame random values (populated each frame in game loop)
    frameRandom: [],
  };

  return state;
}
